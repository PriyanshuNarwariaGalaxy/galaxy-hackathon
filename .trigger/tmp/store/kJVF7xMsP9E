{
  "version": 3,
  "sources": ["../../../../../../../../../src/trigger/providers/fallback.ts"],
  "sourcesContent": ["import { logger } from \"@trigger.dev/sdk/v3\";\nimport type { FallbackOptions, ProviderAttemptLog, ProviderId } from \"./types\";\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction withTimeout<T>(promise: Promise<T>, timeoutMs: number, label: string): Promise<T> {\n  if (timeoutMs <= 0) return promise;\n  let t: NodeJS.Timeout | undefined;\n  const timeoutPromise = new Promise<T>((_, reject) => {\n    t = setTimeout(() => reject(new Error(`Timed out after ${timeoutMs}ms (${label})`)), timeoutMs);\n  });\n  return Promise.race([promise, timeoutPromise]).finally(() => {\n    if (t) clearTimeout(t);\n  });\n}\n\n/**\n * Provider fallback engine (Phase 3).\n *\n * - Tries providers in order.\n * - Retries each provider up to `retryPerProvider`.\n * - Applies a per-attempt timeout.\n * - Returns the first successful output and the provider used.\n *\n * This is runtime-agnostic: the caller supplies the provider-specific execute fn.\n */\nexport async function executeWithFallback<TOutput>(\n  opts: FallbackOptions,\n  execute: (provider: ProviderId) => Promise<TOutput>,\n): Promise<{ output: TOutput; providerUsed: ProviderId; attempts: ProviderAttemptLog[] }> {\n  const attempts: ProviderAttemptLog[] = [];\n\n  const providers = opts.providers ?? [];\n  if (providers.length === 0) {\n    throw new Error(\"No providers specified for fallback execution.\");\n  }\n\n  const tries = Math.max(1, opts.retryPerProvider);\n\n  for (const provider of providers) {\n    for (let attempt = 1; attempt <= tries; attempt++) {\n      const startedAt = nowIso();\n      logger.info(\"Provider attempt start\", { provider, attempt });\n      try {\n        const output = await withTimeout(\n          execute(provider),\n          opts.timeoutMs,\n          `provider=${provider} attempt=${attempt}`,\n        );\n        const finishedAt = nowIso();\n        attempts.push({ provider, attempt, startedAt, finishedAt, ok: true });\n        logger.info(\"Provider attempt success\", { provider, attempt });\n        return { output, providerUsed: provider, attempts };\n      } catch (err) {\n        const finishedAt = nowIso();\n        const message = err instanceof Error ? err.message : String(err);\n        attempts.push({ provider, attempt, startedAt, finishedAt, ok: false, error: message });\n        logger.warn(\"Provider attempt failed\", { provider, attempt, error: message });\n      }\n    }\n  }\n\n  throw new Error(\n    `All providers failed. Attempts: ${attempts\n      .map((a) => `${a.provider}#${a.attempt}:${a.ok ? \"ok\" : \"fail\"}`)\n      .join(\", \")}`,\n  );\n}\n\n"],
  "mappings": ";;;;;;;;;;AAAA;AAGA,SAAS,SAAS;AAChB,UAAO,oBAAI,KAAK,GAAE,YAAY;AAChC;AAFS;AAIT,SAAS,YAAe,SAAqB,WAAmB,OAA2B;AACzF,MAAI,aAAa,EAAG,QAAO;AAC3B,MAAI;AACJ,QAAM,iBAAiB,IAAI,QAAW,CAAC,GAAG,WAAW;AACnD,QAAI,WAAW,MAAM,OAAO,IAAI,MAAM,mBAAmB,SAAS,OAAO,KAAK,GAAG,CAAC,GAAG,SAAS;AAAA,EAChG,CAAC;AACD,SAAO,QAAQ,KAAK,CAAC,SAAS,cAAc,CAAC,EAAE,QAAQ,MAAM;AAC3D,QAAI,EAAG,cAAa,CAAC;AAAA,EACvB,CAAC;AACH;AATS;AAqBT,eAAsB,oBACpB,MACA,SACwF;AACxF,QAAM,WAAiC,CAAC;AAExC,QAAM,YAAY,KAAK,aAAa,CAAC;AACrC,MAAI,UAAU,WAAW,GAAG;AAC1B,UAAM,IAAI,MAAM,gDAAgD;AAAA,EAClE;AAEA,QAAM,QAAQ,KAAK,IAAI,GAAG,KAAK,gBAAgB;AAE/C,aAAW,YAAY,WAAW;AAChC,aAAS,UAAU,GAAG,WAAW,OAAO,WAAW;AACjD,YAAM,YAAY,OAAO;AACzB,aAAO,KAAK,0BAA0B,EAAE,UAAU,QAAQ,CAAC;AAC3D,UAAI;AACF,cAAM,SAAS,MAAM;AAAA,UACnB,QAAQ,QAAQ;AAAA,UAChB,KAAK;AAAA,UACL,YAAY,QAAQ,YAAY,OAAO;AAAA,QACzC;AACA,cAAM,aAAa,OAAO;AAC1B,iBAAS,KAAK,EAAE,UAAU,SAAS,WAAW,YAAY,IAAI,KAAK,CAAC;AACpE,eAAO,KAAK,4BAA4B,EAAE,UAAU,QAAQ,CAAC;AAC7D,eAAO,EAAE,QAAQ,cAAc,UAAU,SAAS;AAAA,MACpD,SAAS,KAAK;AACZ,cAAM,aAAa,OAAO;AAC1B,cAAM,UAAU,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG;AAC/D,iBAAS,KAAK,EAAE,UAAU,SAAS,WAAW,YAAY,IAAI,OAAO,OAAO,QAAQ,CAAC;AACrF,eAAO,KAAK,2BAA2B,EAAE,UAAU,SAAS,OAAO,QAAQ,CAAC;AAAA,MAC9E;AAAA,IACF;AAAA,EACF;AAEA,QAAM,IAAI;AAAA,IACR,mCAAmC,SAChC,IAAI,CAAC,MAAM,GAAG,EAAE,QAAQ,IAAI,EAAE,OAAO,IAAI,EAAE,KAAK,OAAO,MAAM,EAAE,EAC/D,KAAK,IAAI,CAAC;AAAA,EACf;AACF;AAzCsB;",
  "names": []
}
